name: Deploy to EC2 - SINF Project

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Para ejecutar manualmente

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v3

    # ========== SECCIÓN DEBUGGING ==========
    - name: 🔍 DEBUG - Show environment info
      run: |
        echo "=== DEBUG INFORMATION ==="
        echo "GitHub Event: ${{ github.event_name }}"
        echo "Repository: ${{ github.repository }}"
        echo "Workflow: ${{ github.workflow }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "Run Number: ${{ github.run_number }}"
        echo "========================="
        
    - name: 🔍 DEBUG - Show EC2_HOST (masked)
      run: |
        echo "Checking EC2_HOST secret..."
        echo "EC2_HOST length: ${#EC2_HOST} characters"
        
        # Muestra formato (primeros y últimos caracteres)
        if [ -n "$EC2_HOST" ]; then
          echo "EC2_HOST starts with: ${EC2_HOST:0:15}"
          echo "EC2_HOST ends with: ${EC2_HOST: -15}"
          
          # Verifica si es IP o DNS
          if [[ "$EC2_HOST" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "✅ EC2_HOST parece una dirección IP válida"
          else
            echo "🌐 EC2_HOST parece un nombre DNS/hostname"
          fi
        else
          echo "❌ ERROR: EC2_HOST está vacío o no definido"
          exit 1
        fi
        
    - name: 🔍 DEBUG - Test network connectivity
      run: |
        echo "Testing network connectivity..."
        
        # Extrae solo el hostname/IP (sin http://)
        HOST=$(echo "$EC2_HOST" | sed 's|^https\?://||' | sed 's|/.*||')
        echo "Testing connection to: $HOST"
        
        # Prueba ping (solo para diagnóstico)
        ping -c 2 $HOST 2>/dev/null && echo "✅ Ping successful" || echo "⚠️ Ping failed (puede ser normal)"
        
        # Prueba puerto 22
        timeout 5 bash -c "echo > /dev/tcp/$HOST/22" 2>/dev/null
        if [ $? -eq 0 ]; then
          echo "✅ Puerto 22 está ABIERTO en $HOST"
        else
          echo "❌ Puerto 22 está CERRADO o no responde"
          echo "⚠️ Posibles causas:"
          echo "  1. Instancia EC2 apagada"
          echo "  2. Security Group no permite SSH"
          echo "  3. IP incorrecta"
          echo "  4. Firewall bloqueando"
        fi
        
        # Muestra IP pública del runner (para debugging)
        echo "GitHub Runner public IP:"
        curl -s ifconfig.me
        echo ""
    # ========== FIN DEBUGGING ==========

    - name: 🔑 Setup SSH Key
      run: |
        echo "Setting up SSH key..."
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_key.pem
        chmod 600 ~/.ssh/ec2_key.pem
        
        # Verificar formato de la clave
        echo "Verificando formato de clave SSH..."
        head -1 ~/.ssh/ec2_key.pem
        if grep -q "BEGIN RSA PRIVATE KEY" ~/.ssh/ec2_key.pem; then
          echo "✅ Formato de clave correcto (RSA)"
        elif grep -q "BEGIN OPENSSH PRIVATE KEY" ~/.ssh/ec2_key.pem; then
          echo "✅ Formato de clave correcto (OPENSSH)"
        else
          echo "❌ ERROR: Formato de clave desconocido"
          echo "Primera línea:"
          head -1 ~/.ssh/ec2_key.pem
          exit 1
        fi
        
        # Verificar que la clave es válida
        if ssh-keygen -y -f ~/.ssh/ec2_key.pem > /dev/null 2>&1; then
          echo "✅ SSH key is valid"
        else
          echo "❌ ERROR: Invalid SSH key"
          echo "Asegúrate de que el secret SSH_PRIVATE_KEY contiene:"
          echo "1. La clave COMPLETA .pem"
          echo "2. Con líneas -----BEGIN y -----END"
          echo "3. Sin espacios extra al principio/fin"
          exit 1
        fi

    - name: 🔍 DEBUG - Show SSH key info
      run: |
        echo "=== SSH KEY INFO ==="
        echo "Tamaño de la clave: $(wc -l < ~/.ssh/ec2_key.pem) líneas"
        echo "Primeras 2 líneas:"
        head -2 ~/.ssh/ec2_key.pem
        echo "Últimas 2 líneas:"
        tail -2 ~/.ssh/ec2_key.pem
        echo "===================="

    - name: 🧪 Test SSH Connection
      run: |
        echo "🔌 Testing SSH connection to EC2..."
        echo "Host: ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}"
        echo "Timeout: 30 seconds"
        
        # Intentar conexión con verbose output
        ssh -vvv \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            -o BatchMode=yes \
            -o LogLevel=DEBUG3 \
            -i ~/.ssh/ec2_key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "echo '✅ SSH Connection successful'; echo 'Hostname: $(hostname)'; echo 'Date: $(date)'; echo 'Uptime: $(uptime)'" \
        || {
          echo "❌ SSH Connection FAILED"
          echo "=== TROUBLESHOOTING ==="
          echo "1. Verifica que la instancia EC2 está RUNNING"
          echo "2. Verifica Security Group (puerto 22 abierto)"
          echo "3. Verifica la IP en EC2_HOST: ${{ secrets.EC2_HOST }}"
          echo "4. Verifica la clave SSH en GitHub Secrets"
          echo "5. Prueba manualmente: ssh -i key.pem ubuntu@IP"
          exit 1
        }

    - name: 🚀 Deploy Application
      run: |
        echo "🚀 Starting deployment..."
        ssh -o StrictHostKeyChecking=no \
            -i ~/.ssh/ec2_key.pem \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} '
        
          echo "📊 System Information:"
          echo "Hostname: $(hostname)"
          echo "IP: $(curl -s ifconfig.me)"
          echo "Date: $(date)"
          echo ""
          
          echo "🐳 Docker status:"
          docker --version
          docker-compose --version
          echo ""
          
          APP_DIR="/home/ubuntu/sinf-app"
          mkdir -p $APP_DIR
          cd $APP_DIR
          
          echo "📂 Working in: $(pwd)"
          
          # Crear docker-compose.yml simple para test
          cat > docker-compose.yml << "EOF"
          version: "3.8"
          services:
            web:
              image: nginx:alpine
              ports:
                - "80:80"
              volumes:
                - ./html:/usr/share/nginx/html
          EOF
          
          mkdir -p html
          echo "<h1>✅ CI/CD Test Successful!</h1><p>Deployed at: $(date)</p>" > html/index.html
          
          docker-compose down 2>/dev/null || true
          docker-compose up -d
          
          echo "📊 Containers:"
          docker-compose ps
          
          echo "✅ Deployment test completed"
        '

    - name: ✅ Verify Deployment
      run: |
        echo "🏥 Verifying deployment..."
        sleep 10
        
        echo "Testing web server..."
        if curl -f --max-time 30 http://${{ secrets.EC2_HOST }}; then
          echo "✅ ✅ ✅ WEB SERVER IS WORKING!"
        else
          echo "⚠️ Web server not responding yet"
          echo "Check manually: http://${{ secrets.EC2_HOST }}"
        fi

    - name: 📋 Generate Report
      if: always()
      run: |
        echo "=== DEPLOYMENT REPORT ==="
        echo "Status: ${{ job.status }}"
        echo "Time: $(date)"
        echo "EC2 Host: ${{ secrets.EC2_HOST }}"
        echo "Workflow: ${{ github.workflow }}"
        echo "Run: ${{ github.run_number }}"
        echo "========================="
